
```{r abundanceAnnotation}
# annotate
a@abundance <- a@abundance %>%
   left_join( db %>% 
                 select(!!!rlang::syms(unique(c("sample_id", 
                                                "subject_id", 
                                                "tissue", 
                                                params$cloneby))
                                       )
                  ) %>%
                 distinct(),
              
              )
p <- plotAbundanceCurve(a, annotate="depth", silent = T) 
```

```{r clonalAbundanceTable, results='asis'}
tab <- eetable(a@abundance, file = "clonal_abundance", 
               outdir=params$outdir, show_max=10,
               caption="Example 10 lines of the clonal abundance file.")
tab$table %>%
        DT::formatRound(columns=c("p","p_sd","lower","upper"),digits=3)
```
```{r echo=FALSE, results='asis'}
print_table_caption("clonal_abundance", tab$caption)
```

## Abundance plot by sample

```{r abundanceSample, eval=TRUE,  fig.cap=caption, fig.width=8, fig.height=0.7*length(unique(db[['sample_id']]))}
# plot duplicated cells
abundanceSample <- p + facet_wrap(~ subject_id + sample_id, ncol=3)
abundanceSample <- eeplot(abundanceSample, 
                     outdir=params$outdir, 
                     file=knitr::opts_current$get('label'),
                     caption="Clonal abundance plot.",
                     a)
abundanceSample
caption <- abundanceSample$enchantr$html_caption  
```

## Abundance plot by tissue

```{r abundanceTissue, eval=TRUE, fig.width=6, fig.height=2*length(unique(db[['tissue']])), fig.cap=caption}
# plot duplicated cells
abundanceTissue <- p + facet_wrap(~ tissue)
abundanceTissue <- eeplot(abundanceTissue, 
                     outdir=params$outdir, 
                     file=knitr::opts_current$get('label'),
                     caption="Clonal abundance plot visualized by tissue.")
abundanceTissue
caption <- abundanceTissue$enchantr$html_caption  
```


# Diversity

The clonal abundance distribution can be characterized using diversity statistics. Diversity scores (D) are calculated using the generalized diversity index (Hill numbers), which covers many different measures of diversity in a single function with a single varying parameter, the diversity order q.

The function alphaDiversity resamples the sequences (`r params$nboot` random bootstrapping events, with the number of sequences in the sample with less sequences (N)) and calculates diversity scores (D) over a interval of diversity orders (q). The diversity (D) is shown on the y-axis and the x-axis is the parameter q. - q = 0 corresponds to Species Richness - q = 1 corresponds to Shannon Entropy - q = 2 corresponds to Simpson Index

Inspection of this figure is useful to determine whether any difference in diversity between two repertoires depends on the statistic used or if it is a universal property. 


The clonal diversity $D$ of the repertoire was calculated according to the general formula of Hill Diversity
numbers:

$$
\begin{aligned}
    ^{q}D = \left( \sum_{i=1}^Rp_i^q \right)^{1/(1-q)}
\end{aligned}
$$

where:

* $p_i$ is the proportion of unique sequences belonging to clone $i$.
* $q$ are the values of the different diversity numbers.
* $R$ is the Richness, the number of different clones in the sample.

At $q=1$ the function is undefined and the limit to zero equals the exponential of the Shannon Entropy:

$$
\begin{aligned}
    ^{1}D = exp \left(  \sum_{i=1}^Rp_i ln(p_i)  \right)
\end{aligned}
$$

The intuition about the different Hill Diversity values is the following:

* At $q=0$ the diversity index equals the number of clones in the sample.
* At $q=1$ the diversity index is the geometric mean of the clones in the sample,
weighted by their proportion in the sample.
* At $q>1$ more weight is given to the clones with higher proportions in the sample.


## Diversity curves

```{r diversity, results='asis'}
# generate the Hill diversity curve
d <- alphaDiversity(db %>% filter(isHeavyChain(locus)), 
                    group = "sample_id", 
                    min_n=params$min_n)
diversitySample <- plotDiversityCurve(d, silent = T, annotate="depth")

tab <- eetable(d@diversity, file = "clonal_diversity", 
               outdir=params$outdir, show_max=10,
               caption="Example 10 lines of the clonal diversity file.")
tab$table %>%
        DT::formatRound(columns=c("q","d","d_sd","d_lower", "d_upper", "e", "e_lower", "e_upper"),digits=3)
```
```{r echo=FALSE,results='asis'}
print_table_caption("clonal_diversity", tab$caption)
```

```{r diversitySample, eval=TRUE,  fig.cap=caption, fig.width=7, fig.height=max(6,0.3*length(unique(db[['sample_id']])))}
# plot duplicated cells
diversitySample <- diversitySample + 
    geom_vline(xintercept = c(0,1,2), color = "grey50", linetype = "dashed") +
    geom_text(data = data.frame(q = c(0,1,2), y = round(max(p$data$d_upper)/2),
              label = c("Richness", "Shannon", "Simpson")),
              aes(x = q, y = y,label = label), size = 3, angle = 90, vjust = -0.4, inherit.aes  =  F, color = "grey50") +
    facet_wrap(~sample_id)
diversitySample <- eeplot(diversitySample, 
                     outdir=params$outdir, 
                     file=knitr::opts_current$get('label'),
                     caption="Clonal diversity per `sample_id`.",
                     d)
diversitySample
caption <- diversitySample$enchantr$html_caption 
```
